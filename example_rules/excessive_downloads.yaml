# Alert when the rate of events exceeds a threshold

# (Required)
# Elasticsearch host
es_host: 127.0.0.1

# (Required)
# Elasticsearch port
es_port: 9505

# (OptionaL) Connect with SSL to elasticsearch
#use_ssl: True

# (Optional) basic-auth username and password for elasticsearch
#es_username: someusername
#es_password: somepassword

# (Required)
# Rule name, must be unique
name: Excessive Document Downloads Alert
description: Number of document downloads exceeded the threshold for some users during the pre-set period.

# (Required)
# Type of alert.
# the frequency rule type alerts when num_events events occur with timeframe time
type: customrules.CardinalityRule

# (Required, CardinalityRule specific)
# Alert when this many documents matching the query occur within a timeframe, this must also appear in query_key
cardinality_term: "document_id"

# (Required)
# Index to search, wildcard supported
index: dldm-prod-server

timestamp_field: "@timestamp"

# (Required, frequency specific)
# Alert when this many documents matching the query occur within a timeframe
max_cardinality: 5

# (Required, frequency specific)
# num_events must occur within this amount of time to trigger an alert
timeframe:
  hours: 24

# (Required)
# A list of elasticsearch filters used for find events
# These filters are joined with AND and nested in a filtered query
# For more info: http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl.html
filter:
- query:
    query_string:
      query: '(msg.analyzed:"Serving document request in docx format" OR msg.analyzed:"Serving document request in pdf format") AND (NOT user:*dragonlaw.com*) AND (NOT doctype_title:"Confidentiality Agreement") AND (NOT doctype_title:"Website Privacy Policy Statement")'

doc_type: prod-server
query_key: 
- "user"
- "document_id"
- "time"

# this must be one of query_key
bucket_key: user
time_field: time
storage: "/tmp/dldm/elastalertConfig/tmp/docDownloads.json"

# (Required)
# The alert is use when a match is found
alert:
- "email"

# (required, email specific)
from_addr: "admin@dragonlaw.com.hk"
# a list of email addresses to send alerts to
email:
- "terry.wong@dragonlaw.com.hk"
- "oliver.boote@dragonlaw.com.hk"
- "chris.sykes@dragonlaw.com.hk"

bcc:
- "lingxiao.xia@dragonlaw.com.hk"

smtp_host: smtp.mandrillapp.com
smtp_port: 587
smtp_ssl: True
smtp_auth_file: "/tmp/dldm/elastalertConfig/smtp_auth.yaml"

alert_subject: "Excessive Document Downloads Alert!"